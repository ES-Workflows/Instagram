name: Fetch Instagram Data

on:
  schedule:
    # Run every 4 hours (UTC)
    - cron: '0 */4 * * *'
  workflow_dispatch:   # Allow manual trigger
  push:
    branches: [ main ]

permissions:
  contents: write   # Required to push to repo

jobs:
  fetch-instagram-data:
    runs-on: ubuntu-latest

    steps:
    # ğŸ§© Step 1: Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    # ğŸ Step 2: Set up Python environment
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # ğŸ“¦ Step 3: Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas requests numpy supabase

    # ğŸ” Step 4: Display current repository state
    - name: Display current files in repo
      run: |
        echo "ğŸ“ Current files in repository:"
        ls -la
        echo "ğŸ“Š Current CSV files:"
        shopt -s nullglob
        for file in *.csv; do
          echo "$file: $(wc -l < "$file") lines"
        done

    # âš™ï¸ Step 5: Run the data fetch script
    - name: Run Instagram data fetch script
      env:
        SCRAPINGDOG_API_KEY: ${{ secrets.SCRAPINGDOG_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        set -e  # Exit if any error occurs
        echo "ğŸš€ Running Instagram data fetch script..."
        python fetch_instagram_data.py
        echo "âœ… Script execution completed."

    # ğŸ§¾ Step 6: Verify updated files
    - name: Verify updated files
      run: |
        echo "ğŸ“ Files after script execution:"
        ls -la
        echo "ğŸ“Š Updated CSV files:"
        shopt -s nullglob
        for file in *.csv; do
          echo "$file: $(wc -l < "$file") lines"
        done

    # ğŸ’¾ Step 7: Commit and push updated data
    - name: Commit and push updated CSV files
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Add any CSVs in any folder (root or nested)
        git add **/*.csv || echo "No CSV files to add."

        # Check for new or modified content
        if git diff --cached --quiet; then
          echo "âœ… No changes detected â€” everything up to date."
        else
          echo "ğŸ“ Changes detected â€” committing updates..."
          git commit -m "ğŸ¤– Auto-update: Instagram data [$(date +'%Y-%m-%d %H:%M')]"
          echo "ğŸš€ Pushing changes to main branch..."
          git push origin main
          echo "âœ… Successfully pushed updates to repository."
        fi
